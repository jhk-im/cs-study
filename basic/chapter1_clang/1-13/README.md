# 동적 메모리 할당

```txt
1) 동적 메모리 할당의 원리를 학습
2) 동적 메모리 할당을 이용해 프로그램 실행 도중에 메모리가 할당되도록 한다. 
```

---

## 동적 메모리 할당의 개념

1) 일반적으로 c언어에서 배열의 경우 사전에 적절한 크기만큼 할당해 주어야 한다.
2) 우리가 원하는 만큼만 메모리를 할당해서 사용하고자 한다면 동적 메모리 할당을 사용한다.
3) 동적이라는 말은 프로그램 실행 도중이라는 의미이다.

### 동적 메모리 할당 함수

1) c언어에서는 malloc() 함수를 이용해 원하는 만큼의 메모리 공간을 확보할 수 있다.
2) malloc() 함수는 메모리 할당에 성공하면 주소를 반환하고, 그렇지 않으면 null을 반환한다.
3) malloc() 함수는 <stdlib.h> 라이브러리에 정의되어 있다.

```c
malloc(할당 할 바이트 크기);
```

-> 동적 메모리 할당을 수행할 때 마다 항당되는 포인터의 주소는 변칙적이다.

```c
#include <stdio.h>
#include <stdlib.h>

int main(void) {
 int* a = malloc(sizeof(int));
 printf("%d\n", a);
 a = malloc(sizeof(int));
 printf("%d\n", a);
 system("pause");
 return 0;
}
```

```cmd
14504368
14504416
```

* int = 4bytes -> sizof(int) = 4bytes
* 위 주소는 실행때마다 변칙적으로 바뀐다.
* 같을 수도 있고 다를 수도 있다.
* 이렇게 동적으로 할당된 변수는 힙 영역에 저장된다.
* 현재 사용되지 않는 메모리에 프로그램이 알아서 주소를 할당한다.

|코드영역|데이터영역|힙영역(동적할당 변수)|스택영역|
|-|-|-|-|-|

1) 전동적인 c언어에서는 스택에 선언된 변수는 따로 메모리 해제를 해주지 않아도 된다.
2) 반면 동적으로 할당된 변수는 반드시 free()함수로 메모리 해제를 해주어야 한다.
3) 메모리 해제를 하지 않으면 메모리 내의 프로세스 무게가 더해져 오류가 발생할 수 있다.
4) 메모리 누수 memory leak 방지는 코어 개발자의 핵심 역량이다.

```c
#include <stdio.h>
#include <stdlib.h>

int main(void) {
 int* a = malloc(sizeof(int));
 printf("%d\n", a);
 free(a);
 a = malloc(sizeof(int));
 printf("%d\n", a);
 free(a);
 system("pause");
 return 0;
}
```

```cmd
22827440
22827440
```

* 웬만해서는 동일한 메모리가 할당된다.
* 메모리 자리가 비기 때문에 그 자리를 채우는 것이다.
* free()함수를 사용하면 확률적으로 100%에 가깝게 같은 주소값이 할당된다.

---

### 동적으로 문자열 처리하기

 1) 일괄적인 범위의 메모리를 모두 특정한 값으로 설정하기 위해서는 memset()을 사용한다.
 2) memset(포인터, 값, 크기);
 3) 한 바이트 씩 값을 저장하므로 문자열 배열의 처리 방식과 흡사하다.
 4) 따라서 memset() 함수는 <string.h> 라이브러리에 선언되어있다.

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(void) {
 char* a = malloc(100);
 memset(a, 'A', 100);
 for (int i = 0; i < 100; i++) {
  printf("%c ", a[i]);
 }
 system("pause");
 return 0;
}
```

* 100 개의 A 출력

---

### 동적 메모리 할당의 다양한 예제

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(void) {
 int** p = (int**)malloc(sizeof(int*) * 3); 
 for (int i = 0; i < 3; i++) {
  *(p + i) = (int**)malloc(sizeof(int) * 3);
 }
 for (int i = 0; i < 3; i++) {
  for (int j = 0; j < 3; j++) {
   *(*(p + i) + j) = i * 3 + j;
  }
 }
 for (int i = 0; i < 3; i++) {
  for (int j = 0; j < 3; j++) {
   printf("%d ", *(*(p + i) + j));
  }
  printf("\n");
 }
 system("pause");
 return 0;
}
```

```cmd
0 1 2
3 4 5
6 7 8
```

* int** p -> 2중 포인터 -> 3개의 행이 들어가는 이중포인터를 메모리 할당을 통해 생성
* for() -> 3번 반복해면서 3개의 행이 들어가는 3개의 열도 생성
* sizeof(int*) -> 1개의 포인터는 1개의 1차원 배열을 처리할 수 있음
* `*(p + i)` -> 각각의 행을 의미함
* `*(*(p + i) + j)` -> 특정 행에서 몇번째 열인지 j를 통해 알려준다.
* i * 3 + j; -> i와 j 모두 012로 증가하므로 012 345 678이 입력된다.
* a[][]를 사용하지 않고 정확히 사용하고 싶은 메모리 만큼을 할당하여 효율적으로 메모리 공간을 활용하는 예제이다.
* 프로그램이 종료되면 할당된 메모리는 전부 해제되기 때문에 free()함수를 사용하지 않았다.
* 상용프로그램을 만드는 것이라면 free()함수를 사용해야한다.

---

### 배운내용 정리

1) 동적 메모리 할당을 이용해 프로그램이 실행중인 도중에 메모리 공간을 배정받을 수 있다.
2) 동적으로 할당 받은 프로그램은 반드시 명시적으로 free() 함수를 이용해 할당 해제를 해야한다.
